# 数据库：SQL入门及JDBC的使用

## 前言

哥们哥们，来学一学数据库  
绕的我有点晕，特别是**连接JOIN**那一块  
目录看着长，内容不长。

## 数据库简述

先说一些教材上的知识，数据库按照数据结构来组织、存储和管理数据，大体可分为三种模型：

- 层次模型：以“上下级”的层次关系来组织数据的一种方式，其数据结构看起来就像一颗树
- 网状模型：把每个数据节点和其他很多节点都连接起来，其数据结构像很多城市之间的路网
- 关系模型：类似一个二维表格，任何数据都可以通过`行号+列号`来唯一确定

数据库软件又称**数据库管理系统（DBMS，Database Management System）**，目前，市面上大部分使用的是基于关系模型的关系数据库，即**关系型数据库**  
而主流的关系型数据库分为以下几类，他们又称为**关系型数据库管理系统（RMDBS，Relational Database Management System）**：

1. 商用数据库：[Oracle](https://www.oracle.com/)，[SQL Server](https://www.microsoft.com/sql-server/)，[DB2](https://www.ibm.com/db2/)等
2. 开源数据库：[MySQL](https://www.mysql.com/)，[PostgreSQL](https://www.postgresql.org/)等
3. 桌面数据库：微软的[Access](https://products.office.com/access)等，适合桌面应用程序使用
4. 嵌入式数据库：[Sqlite](https://sqlite.org/)等，适合手机应用和桌面程序

## SQL 语言

SQL（Structured Query Language），结构化查询语言，是一种用于操作关系型数据库的计算机语言。  
虽然其是被**ANSI（美国国家标准协会）**标准化的语言，但是它有很多不同的实现版本。

SQL语言定义了以下几种操作数据库的能力：

- DDL，Data Definition Language：允许用户定义数据，也就是创建表、删除表、修改表结构这些操作。通常由管理员执行。
- DML，Data Manipulation Language：为用户提供添加、删除、更新数据的能力，通常由应用程序对数据库进行操作。
- DQL，Data Query Language：允许用户查询数据，这也是通常最频繁的数据库日常操作。

SQL本身大小写不敏感，即不区分大小写，但是表名和列名是否大小写敏感由数据库决定。  
顺便一提，数据库每一列的列头叫**字段**，一行数据叫**记录**，不会有人不知道吧 **:>**

其常用数据类型如下：

| 名称         | 类型           | 说明                                                         |
| ------------ | -------------- | ------------------------------------------------------------ |
| INT          | 整型           | 4字节整数类型，范围约+/-21亿                                 |
| BIGINT       | 长整型         | 8字节整数类型，范围约+/-922亿亿                              |
| REAL         | 浮点型         | 4字节浮点数，范围约+/-1038                                   |
| DOUBLE       | 浮点型         | 8字节浮点数，范围约+/-10308                                  |
| DECIMAL(M,N) | 高精度小数     | 由用户指定精度的小数，例如，DECIMAL(20,10)表示一共20位，其中小数10位，通常用于财务计算 |
| CHAR(N)      | 定长字符串     | 存储指定长度的字符串，例如，CHAR(100)总是存储100个字符的字符串 |
| VARCHAR(N)   | 变长字符串     | 存储可变长度的字符串，例如，VARCHAR(100)可以存储0~100个字符的字符串 |
| BOOLEAN      | 布尔类型       | 存储True或者False                                            |
| DATE         | 日期类型       | 存储日期，例如，2018-06-22                                   |
| TIME         | 时间类型       | 存储时间，例如，12:20:59                                     |
| DATETIME     | 日期和时间类型 | 存储日期+时间，例如，2018-06-22 12:20:59                     |

此外，很多数据类型还有别名，如`REAL`可以写成`FLOAT(24)`。各数据库厂商还会支持特定的数据类型，例如`JSON`。

## SQL基础操作

即**增删查改**，又被称为**CRUD**  
C: Create，U: Update，R: Retrive，D: Delete

### SELECT - 查询

查询是SQL最为重要，也是功能最多、可以变得很复杂的操作。因此这里就不多说了，直接上一个模板：

```sql
SELECT [DISTINCT] * # *表示所有列，也可以指定一个或多个列，用逗号隔开
					# DISTINCT 表示当出现相同记录的时候只显示一个
FROM <表名>
WHERE ... AND ... OR ...	# 指定条件
ORDER BY <列1>, <列2> ASC / DESC # 排序，ASC升序，DESC降序；
								#可以指定一个或多个列，会先按<列1>排序，若相同再按<列2>排序
LIMIT 2	# 限制输出条数
OFFSET 3	# 跳过前三条记录，即输出第4，第5条记录（OFFSET 0显示第一条记录）
```

当指定一个或多个列而不是用`*`搜索所有列的时候，也被称为`投影`  
而排序默认是升序，所以`ASC`可以省略；也可以若干列升序，若干列降序：

```sql
ORDER BY <列1> ASC, <列2> DESC
```

在MySQL中，`LIMIT 15 OFFSET 30`还可以简写成`LIMIT 30, 15`  
如果`OFFSET`超过了查询的最大数量并不会报错，而是得到一个空的结果  
注意`OFFSET`越大，查询效率也会越低

#### LIKE操作和通配符

SQL支持以下几种**通配符（wildcard）**，用于在`WHERE`中作为条件，当使用通配符时，必须使用`LIKE`关键字操作  

- 百分号（%）：表示任何字符出现任意次数。`WHERE name LIKE 'A%'`表示`name字段以A开头`
- 下划线（_）：表示单个任意字符。
- 方括号（[]）：指定一个字符集。`WHERE name LIKE '[AB]%'`表示`name字段以A开头或B开头`

其实有点像正则表达式。注意`LIKE`和通配符操作只能用于文本字段

#### 拼接和计算字段

在某些情况下我们需要将两个字段的内容进行**拼接**，可以用`+`  
假设一个用户表`users`存有用户的`first_name`和`last_name`，我们将其拼接，并用`AS`设置新字段的别名：

```sql
SELECT first_name + ' ' + last_name AS full_name FROM users
```

在某些数据库中用`||`而非`+`，而在`MySQL`中拼接需要使用`CONCAT()`函数

此外，`SELECT`还可以进行**算数计算**  
假设一个订单表`orders`存有商品单价`single_price`和商品数量`quantity`，我们需要计算一个订单的总价格，并用`AS`设置新字段的别名：

```sql
SELECT single_price * quantity AS total_price FROM orders
```

常用的加减乘除运算符都那样：`（+，-，*，/）`

#### 联合查询

假设我们有以下两个表：

```sql
# 表1: users 用户表
  (id, name, age)
  (1, '晓黑', 19)
  (2, 'BlackDawn', 22)
  ------------
  # 表2: posts 文章表
  (post_id, title, poster_id)
  (1, 'title 1', 1)
  (2, 'title 2', 1)
  (3, 'hello', 2)
```

当我们联合查询两个表中的数据的时候，如果单单指定两个表，SQL会将两个表的每一行两两拼在一起 ：

```sql
SELECT * FROM users, posts;
# 结果如下：
  (id, name, age, post_id, title, poster_id)
  (1, '晓黑', 19, 1, 'title 1', 1)
  (1, '晓黑', 19, 2, 'title 2', 1)
  (1, '晓黑', 19, 3, 'hello', 1)
  (2, 'BlackDawn', 22, 1, 'title 1', 1)
  (2, 'BlackDawn', 22, 2, 'title 2', 1)
  (2, 'BlackDawn', 22, 3, 'hello', 1)
```

返回结果列数之和列数是两表列数之和，行数是两表行数之积（**笛卡尔积**）  
显然这种查询结果绝大部分是没有意义的，因此我们要加上`WHERE`进行筛选，就不演示了哈

#### 连接查询



### INSERT - 插入

```sql
INSERT INTO <表名> (字段1, 字段2, ...) VALUES (值1, 值2, ...);
```

注意`字段`和`值`要一一对应，就像**键值对**那样。不过字段的顺序和数据库表中的顺序可以不一样， SQL会检索匹配字段插入数据。  
讲道理，插入一条数据的时候要明确所有字段的值，不过当字段有默认值的时候可以不写（包括自增字段和用户设定默认值的字段）  
此外， 可以在一条语句中插入多条数据：

```sql
INSERT INTO users (id, name, age) VALUES
  (1, '晓黑', 18),
  (2, 'BlackDawn', 22);
```

### UPDATE - 更新

```sql
UPDATE <表名> SET 字段1=值1, 字段2=值2, ... WHERE ...;
```

我们可以在更新的时候进行一些简单的运算：

```sql
UPDATE users SET age=age+1 WHERE id=1;
------------
  (1, '晓黑', 19),
  (2, 'BlackDawn', 22)
```

值得注意的是，`WHERE`中的条件可以是一个范围，这允许我们批量修改多条数据：

```sql
UPDATE users SET name="嘿嘿" WHERE age>10;
------------
  (1, '嘿嘿', 19),
  (2, '嘿嘿', 22)
```

如果`WHERE`后面的条件没有匹配到任何记录，那么SQL不会报错，同样也不会有任记录被修改。  
当`UPDATE`语句不写`WHERE`时，SQL会对表中所有记录执行更新此操作

在**MySQL**中，`UPDATE`语句会返回更新的行数，比如上面两个例子会分别返回`1`和`2`

### DELETE - 删除

```sql
DELETE FROM <表名> WHERE ...;
```

`DELETE`语句也可以通过`WHERE`筛选一次删除多条记录

```sql
DELETE FROM users WHERE id>0;
------------
# 直接全删了
```

如果`WHERE`没有匹配到任何记录，则不会报错，也不会有任何记录被删除。   
不过要注意，如果没有`WHERE`，则会删掉整个表  
和`UPDATE`类似，在**MySQL**中，`DELETE`语句也会返回删除的行数

## SQL函数

### 文本处理函数

| 函数             | 说明                  |
| ---------------- | --------------------- |
| LEFT(<字段>, N)  | 返回字段左边N个字符   |
| LENGTH(<字段>)   | 返回字段的字符长度    |
| LOWER(<字段>)    | 转为小写              |
| LTRIM(<字段>)    | 去掉左边的空格        |
| RIGHT(<字段>, N) | 返回字段右边N个字符   |
| RTRIM(<字段>)    | 去掉右边的空格        |
| SOUNDEX(<字段>)  | 返回字符串的SOUNDEX值 |
| UPPER(<字段>)    | 转为大写              |

注意不是所有函数都是同一名称，比如在**Access**中转为小写的函数为`LCASE()`，转为大写的函数为  
其中，`SOUNDEX`是一个为字符串计算发音的算法，从而实现比较**发音类似**的字符串，虽然其不是SQL特有的概念，但大部分DBMS都支持这个函数。

### 数值处理函数

进行代数、三角、几何运算等，在不同DBMS中这些函数名都比较统一，问题不大

| 函数   | 说明                            |
| ------ | ------------------------------- |
| ABS()  | 计算绝对值                      |
| SQRT() | 计算平方根                      |
| EXP()  | 计算e（自然对数的底）指数的幂值 |
| PI()   | 返回圆周率                      |
| SIN()  | 计算正弦                        |
| COS()  | 计算余弦                        |
| TAN()  | 计算正切                        |

### 聚集函数

所谓**聚集函数（Aggregate Function）**，指的是那些运行在**行组**上（对多个记录的一个或多个列进行计算），最后返回单个值的函数

| 函数    | 说明             |
| ------- | ---------------- |
| AVG()   | 返回某列的平均值 |
| COUNT() | 返回某列的行数   |
| MAX()   | 返回某列的最大值 |
| MIN()   | 返回某列的最小值 |
| SUM()   | 发明会某列之和   |

`AVG()`忽略值为`NULL`的行







### 日期/时间处理函数

一般情况下，由于并非所有编程语言都有表示日期时间的数据结构，就算有也并非一样，所以对于日期时间的的处理通常由数据库完成，然后传回给应用程序进行显示。  
但是由于不同DBMS处理日期和时间的方式不同，比如**SQL Server**和**Access**等使用`DATEPART()`函数，这导致其可移植性很差，大家有需要用到的话就去搜一下吧嘻嘻。











```
count(name)计数
COUNT(DISTINCT column_name)
IFNULL(region_name,0)
as xxx作为新的字段
```

```
INNER JOIN
LEFT JOIN
```

```
AVG(st_score)求得平均数

round(AVG(st_score),2)，对平均数四舍五入保留两位小数
```

## 索引

## 事务

## JDBC

### 数据类型



## 参考

1. [廖雪峰：SQL教程](https://www.liaoxuefeng.com/wiki/1177760294764384)
2. [SQL是什么](http://c.biancheng.net/sql/what-is-sql.html)
3. 
4. 《SQL必会知识》-Ben Forta著，人民邮电出版社
5. [廖雪峰：JDBC编程](https://www.liaoxuefeng.com/wiki/1252599548343744/1255943820274272)
